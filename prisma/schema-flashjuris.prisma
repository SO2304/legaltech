// ============================================
// FLASHJURIS - SCHEMA SUPABASE
// Architecture "Scan-to-Report"
// ============================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_DATABASE_URL")
}

// ============================================
// AVOCAT / LAWYER
// ============================================
model Lawyer {
  id            String   @id @default(cuid())
  email         String   @unique
  name          String
  firm          String?  // Nom du cabinet
  phone         String?
  address       String?
  city          String?
  
  // QR Code
  qrCodeUrl     String   // URL complète: flashjuris.com/scan/[id]
  qrCodeImage   String?  // Image base64 du QR code
  
  // Statut
  isActive      Boolean  @default(true)
  emailVerified DateTime?
  
  // Tarification
  plan         String   @default("free") // free, pro, enterprise
  pricePerCase Int      @default(0)      // Prix en centimes
  
  // Dates
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // Relations
  cases         Case[]
  payments      Payment[]
  
  @@index([email])
  @@index([qrCodeUrl])
}

// ============================================
// DOSSIER CLIENT / CASE
// ============================================
model Case {
  id          String      @id @default(cuid())
  reference   String      @unique @default(cuid()) // Référence unique
  
  // Lien avocat
  lawyerId    String
  lawyer      Lawyer      @relation(fields: [lawyerId], references: [id])
  
  // Données client
  clientName      String?
  clientEmail     String?
  clientPhone     String?
  clientAddress   String?
  clientCity      String?
  caseType        String?     // Type d'affaire: divorce, succession, litige...
  caseDescription String?     @db.Text // Description libre
  
  // Documents uploadés
  documents   Document[]
  
  // Statut du dossier
  status      CaseStatus  @default(pending)
  
  // Analyse IA
  analysis    Analysis?
  
  // Paiement
  payment     Payment?
  
  // Rapport
  reportUrl   String?     // URL du PDF généré
  reportSentAt DateTime?  // Date d'envoi du rapport
  
  // Dates
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  
  @@index([lawyerId])
  @@index([status])
  @@index([reference])
}

// ============================================
// DOCUMENT
// ============================================
model Document {
  id          String    @id @default(cuid())
  caseId      String
  case        Case      @relation(fields: [caseId], references: [id], onDelete: Cascade)
  
  // Fichier
  filename    String
  originalName String
  mimeType    String
  size        Int       // Taille en bytes
  
  // Stockage Supabase
  storagePath String    // Chemin dans Supabase Storage
  publicUrl   String?   // URL publique (si applicable)
  
  // Analyse
  ocrText     String?   @db.Text // Texte extrait par OCR
  isAnalyzed  Boolean   @default(false)
  
  // Sécurité
  hash        String    // Hash SHA-256 pour intégrité
  
  // RGPD - Purge automatique J+30
  deleteAt    DateTime  // Date de suppression automatique
  
  createdAt   DateTime  @default(now())
  
  @@index([caseId])
  @@index([deleteAt])
}

// ============================================
// ANALYSE IA
// ============================================
model Analysis {
  id          String    @id @default(cuid())
  caseId      String    @unique
  case        Case      @relation(fields: [caseId], references: [id], onDelete: Cascade)
  
  // Résultats de l'analyse
  summary     String    @db.Text // Résumé synthétique
  keyPoints   String[]  // Points clés identifiés
  risks       String[]  // Risques identifiés
  recommendations String[] // Recommandations
  nextSteps   String[]  // Prochaines étapes suggérées
  
  // Métadonnées
  aiModel     String    @default("claude-3.5-sonnet")
  tokensUsed  Int?
  
  // Statut
  status      AnalysisStatus @default(processing)
  error       String?
  
  createdAt   DateTime  @default(now())
  completedAt DateTime?
  
  @@index([caseId])
}

// ============================================
// PAIEMENT
// ============================================
model Payment {
  id          String        @id @default(cuid())
  caseId      String        @unique
  case        Case          @relation(fields: [caseId], references: [id])
  lawyerId    String
  lawyer      Lawyer        @relation(fields: [lawyerId], references: [id])
  
  // Montant
  amount      Int           // En centimes
  currency    String        @default("EUR")
  
  // Stripe
  stripePaymentIntent String?
  stripeSessionId     String?
  
  // Statut
  status      PaymentStatus @default(pending)
  
  // Dates
  createdAt   DateTime      @default(now())
  paidAt      DateTime?
  
  @@index([lawyerId])
  @@index([status])
}

// ============================================
// ÉVÉNEMENTS (Audit & Debug)
// ============================================
model Event {
  id          String    @id @default(cuid())
  type        String    // qr_scanned, case_created, analysis_started...
  
  // Données
  lawyerId    String?
  caseId      String?
  metadata    Json?     // Données supplémentaires
  
  // IP & User Agent
  ipAddress   String?
  userAgent   String?
  
  createdAt   DateTime  @default(now())
  
  @@index([type])
  @@index([lawyerId])
  @@index([createdAt])
}

// ============================================
// ENUMS
// ============================================
enum CaseStatus {
  pending       // En attente d'upload
  uploading     // Upload en cours
  pending_payment // En attente de paiement
  processing    // Analyse en cours
  completed     // Terminé
  failed        // Échec
}

enum AnalysisStatus {
  processing    // En cours
  completed     // Terminé
  failed        // Échec
}

enum PaymentStatus {
  pending       // En attente
  succeeded     // Réussi
  failed        // Échec
  refunded      // Remboursé
}
