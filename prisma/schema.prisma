// ============================================
// LEGALTECH DIVORCE - SCHEMA PRISMA
// PostgreSQL (Supabase)
// ============================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// TABLE 1 : Avocat
// ============================================
model Avocat {
  id              String   @id @default(cuid())
  email           String   @unique
  passwordHash    String
  nom             String
  prenom          String
  cabinet         String?

  // Multi-juridiction
  pays            Pays     @default(FRANCE)
  barreau         String?
  numeroInscription String?

  // Stripe Connect
  stripeAccountId String?  @unique
  stripeOnboarded Boolean  @default(false)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  dossiers        Dossier[]

  @@index([email])
  @@index([pays])
  @@map("avocats")
}

// ============================================
// TABLE 2 : Client
// ============================================
model Client {
  id              String   @id @default(cuid())
  email           String
  nom             String
  prenom          String
  telephone       String?

  // Détection géographique
  pays            Pays     @default(FRANCE)
  paysDetecte     Pays?    // Auto-détecté via IP
  ipAddress       String?

  createdAt       DateTime @default(now())

  dossiers        Dossier[]

  @@index([email])
  @@index([pays])
  @@map("clients")
}

// ============================================
// TABLE 3 : Dossier
// ============================================
model Dossier {
  id                    String          @id @default(cuid())
  reference             String          @unique @default(cuid())

  // Relations
  avocatId              String
  avocat                Avocat          @relation(fields: [avocatId], references: [id])
  clientId              String
  client                Client          @relation(fields: [clientId], references: [id])

  // Statut workflow
  statut                DossierStatus   @default(BROUILLON)

  // Juridiction
  pays                  Pays            @default(FRANCE)

  // Données divorce
  typeProcedure         String?
  dateMariage           DateTime?
  nombreEnfants         Int             @default(0)

  // Analyse IA RAG
  analyseIA             String?         @db.Text
  syntheseHTML          String?         @db.Text
  sourcesLegales        String?         @db.Text  // JSON array

  // Paiement Stripe
  montantTTC            Float           @default(149.00)
  fraisGestion          Float           @default(30.00)
  stripePaymentIntent   String?         @unique
  stripePaid            Boolean         @default(false)
  stripePaidAt          DateTime?

  // Purge RGPD
  datePurge             DateTime?       // J+7 après validation
  isPurged              Boolean         @default(false)
  purgedAt              DateTime?

  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt

  documents             Document[]

  @@index([avocatId])
  @@index([statut])
  @@index([pays])
  @@index([stripePaid])
  @@map("dossiers")
}

// ============================================
// TABLE 4 : Document
// ============================================
model Document {
  id                    String          @id @default(cuid())
  dossierId             String
  dossier               Dossier         @relation(fields: [dossierId], references: [id], onDelete: Cascade)

  // Fichier
  type                  DocumentType
  nomOriginal           String
  nomStockage           String          @unique
  mimeType              String
  taille                Int
  cheminStorage         String          // Supabase Storage path

  // OCR & Extraction IA
  texteExtrait          String?         @db.Text
  donneesExtraites      String?         @db.Text  // JSON
  qualiteImage          String?         // BONNE/FLOUE/ILLISIBLE

  // Validation RAG
  exigeLegal            Boolean         @default(false)
  articleLoi            String?         // "Art. 229 Code Civil FR"
  estValide             Boolean         @default(false)

  // Purge
  datePurge             DateTime
  isPurged              Boolean         @default(false)

  createdAt             DateTime        @default(now())

  @@index([dossierId])
  @@index([type])
  @@map("documents")
}

// ============================================
// TABLE 5 : TexteLoi (BASE RAG - CRITIQUE)
// ============================================
model TexteLoi {
  id                    String          @id @default(cuid())

  // Identification
  pays                  Pays
  code                  CodeLegal       // CODE_CIVIL, CODE_PROCEDURE
  article               String          // "229", "1387"
  titre                 String
  contenu               String          @db.Text

  // Embedding pour recherche sémantique (optionnel Phase 1)
  embedding             String?         @db.Text

  // Métadonnées
  dateVigueur           DateTime?
  estActif              Boolean         @default(true)

  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt

  @@unique([pays, code, article])
  @@index([pays, code])
  @@index([estActif])
  @@map("textes_lois")
}

// ============================================
// ENUMS
// ============================================
enum Pays {
  FRANCE
  BELGIQUE
  SUISSE
  LUXEMBOURG
}

enum DossierStatus {
  BROUILLON
  EN_ATTENTE_PAIEMENT
  PAYE
  EN_ANALYSE
  ANALYSE_TERMINEE
  VALIDE
  PURGE
}

enum DocumentType {
  CARTE_IDENTITE
  ACTE_MARIAGE
  BULLETIN_SALAIRE
  AVIS_IMPOSITION
  RELEVE_BANCAIRE
  TITRE_PROPRIETE
  AUTRE
}

enum CodeLegal {
  CODE_CIVIL
  CODE_PROCEDURE_CIVILE
  CODE_FAMILLE
}
