// ============================================
// FLASHJURIS - SCHEMA PRISMA
// Multi-juridiction: FR, BE, CH, LU
// ============================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================
// AVOCAT
// ============================================
model Avocat {
  id                String   @id @default(cuid())
  email             String   @unique
  passwordHash      String?
  nom               String
  prenom            String
  cabinet           String?
  phone             String?
  
  // Multi-juridiction
  pays              Pays     @default(FRANCE)
  barreau           String?
  numeroInscription String?
  
  // Stripe Connect
  stripeAccountId   String?  @unique
  stripeOnboarded   Boolean  @default(false)
  commissionRate    Float    @default(20.0)
  
  // Statut
  isActive          Boolean  @default(true)
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // Relations
  dossiers          Dossier[]
  
  @@index([email])
  @@index([pays])
  @@map("avocats")
}

// ============================================
// CLIENT
// ============================================
model Client {
  id              String   @id @default(cuid())
  email           String
  nom             String
  prenom          String
  telephone       String?
  
  // Géolocalisation
  pays            Pays     @default(FRANCE)
  paysDetecte     Pays?    // Auto-détecté
  ipAddress       String?
  
  createdAt       DateTime @default(now())
  
  dossiers        Dossier[]
  
  @@index([email])
  @@index([pays])
  @@map("clients")
}

// ============================================
// DOSSIER
// ============================================
model Dossier {
  id                    String          @id @default(cuid())
  reference             String          @unique @default(cuid())
  
  // Relations
  avocatId              String
  avocat                Avocat          @relation(fields: [avocatId], references: [id])
  clientId              String
  client                Client          @relation(fields: [clientId], references: [id])
  
  // Workflow
  statut                DossierStatus   @default(BROUILLON)
  pays                  Pays            @default(FRANCE)
  
  // Données divorce
  typeProcedure         String?
  dateMariage           DateTime?
  nombreEnfants         Int             @default(0)
  
  // Analyse IA RAG
  analyseIA             String?         @db.Text
  syntheseHTML          String?         @db.Text
  sourcesLegales        String?         @db.Text  // JSON array
  
  // Paiement Stripe
  montantTTC            Float           @default(149.00)
  fraisGestion          Float           @default(30.00)
  stripePaymentIntent   String?         @unique
  stripePaid            Boolean         @default(false)
  stripePaidAt          DateTime?
  
  // Purge RGPD
  datePurge             DateTime?
  isPurged              Boolean         @default(false)
  purgedAt              DateTime?
  
  documents             Document[]
  
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt
  
  @@index([avocatId])
  @@index([statut])
  @@index([pays])
  @@index([stripePaid])
  @@map("dossiers")
}

// ============================================
// DOCUMENT
// ============================================
model Document {
  id                    String          @id @default(cuid())
  dossierId             String
  dossier               Dossier         @relation(fields: [dossierId], references: [id], onDelete: Cascade)
  
  type                  DocumentType?
  nomOriginal           String
  nomStockage           String          @unique
  mimeType              String
  taille                Int
  cheminStorage         String          // Path dans le storage
  fileData              String?         // Base64 pour envoi email
  
  // OCR & Extraction IA
  texteExtrait          String?         @db.Text
  donneesExtraites      String?         @db.Text  // JSON
  qualiteImage          String?         // BONNE/FLOUE/ILLISIBLE
  
  // Validation RAG
  exigeLegal            Boolean         @default(false)
  articleLoi            String?         // "Art. 229 Code Civil FR"
  estValide             Boolean         @default(false)
  
  // Sécurité
  hash                  String?
  
  // Purge
  datePurge             DateTime?
  isPurged              Boolean         @default(false)
  purgedAt              DateTime?
  
  createdAt             DateTime        @default(now())
  
  @@index([dossierId])
  @@index([type])
  @@index([isPurged])
  @@map("documents")
}

// ============================================
// TEXTE LOI (Base RAG)
// ============================================
model TexteLoi {
  id                    String          @id @default(cuid())
  
  pays                  Pays
  code                  CodeLegal
  article               String
  titre                 String
  contenu               String          @db.Text
  
  embedding             String?         @db.Text
  dateVigueur           DateTime?
  estActif              Boolean         @default(true)
  
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt
  
  @@unique([pays, code, article])
  @@index([pays, code])
  @@index([estActif])
  @@map("textes_lois")
}

// ============================================
// EVENT (Audit)
// ============================================
model Event {
  id          String    @id @default(cuid())
  type        String    // case_created, payment_success, etc.
  
  lawyerId    String?
  caseId      String?
  country     String?
  
  metadata    String?   // JSON 
  
  createdAt   DateTime  @default(now())
  
  @@index([type])
  @@index([country])
  @@index([createdAt])
  @@map("events")
}

// ============================================
// ENUMS
// ============================================
enum Pays {
  FRANCE
  BELGIQUE
  SUISSE
  LUXEMBOURG
}

enum DossierStatus {
  BROUILLON
  EN_ATTENTE_PAIEMENT
  PAYE
  EN_ANALYSE
  ANALYSE_TERMINEE
  VALIDE
  PURGE
}

enum DocumentType {
  CARTE_IDENTITE
  ACTE_MARIAGE
  BULLETIN_SALAIRE
  AVIS_IMPOSITION
  RELEVE_BANCAIRE
  TITRE_PROPRIETE
  AUTRE
}

enum CodeLegal {
  CODE_CIVIL
  CODE_PROCEDURE_CIVILE
  CODE_FAMILLE
}
