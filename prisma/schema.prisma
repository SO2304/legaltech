// ============================================
// FLASHJURIS - SCHEMA PRISMA
// Multi-juridiction: FR, BE, CH, LU
// Works with SQLite (dev) and PostgreSQL (prod)
// ============================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ============================================
// AVOCAT / Avocat
// Multi-juridiction: FRANCE, BELGIQUE, SUISSE, LUXEMBOURG
// ============================================
model Avocat {
  id              String   @id @default(cuid())
  email           String   @unique
  passwordHash    String?
  nom             String
  prenom          String
  cabinet         String?
  phone           String?
  
  // OBLIGATOIRE: Multi-juridiction
  pays            Pays     @default(FRANCE)
  barreau         String?
  numeroInscription String?
  
  // OBLIGATOIRE: Stripe Connect
  stripeAccountId String?  @unique
  stripeOnboarded Boolean  @default(false)
  commissionRate  Float    @default(20.0)  // 20% de commission
  
  // Statut
  isActive      Boolean  @default(true)
  
  // Dates
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // Relations OBLIGATOIRES
  dossiers        Dossier[]
  
  @@index([email])
  @@index([pays])
  @@map("avocats")
}

// ============================================
// CLIENT
// OBLIGATOIRE: Géolocalisation
// ============================================
model Client {
  id              String   @id @default(cuid())
  email           String
  nom             String
  prenom          String
  
  // OBLIGATOIRE: Géolocalisation
  pays            Pays     @default(FRANCE)
  paysDetecte     Pays?    // Auto-détecté
  ipAddress       String?
  
  // Relations OBLIGATOIRES
  dossiers        Dossier[]
  
  createdAt       DateTime @default(now())
  
  @@index([email])
  @@index([pays])
  @@map("clients")
}

// ============================================
// DOSSIER CLIENT / Dossier
// Purge automatique après 7 jours
// ============================================
model Dossier {
  id              String          @id @default(cuid())
  reference       String          @unique @default(cuid())
  
  // Relations OBLIGATOIRES
  avocatId        String
  avocat          Avocat          @relation(fields: [avocatId], references: [id])
  clientId        String
  client          Client          @relation(fields: [clientId], references: [id])
  
  // OBLIGATOIRE: Workflow
  statut          DossierStatus   @default(BROUILLON)
  pays            Pays            @default(FRANCE)
  
  // OBLIGATOIRE: Analyse IA
  analyseIA       String?         
  syntheseHTML    String?         
  sourcesLegales  String?         
  
  // OBLIGATOIRE: Paiement Stripe
  montantTTC      Float           @default(149.00)
  fraisGestion    Float           @default(30.00)
  stripePaymentIntent String?     @unique
  stripePaid      Boolean         @default(false)
  stripePaidAt    DateTime?
  
  // OBLIGATOIRE: Purge RGPD
  datePurge       DateTime?
  isPurged        Boolean         @default(false)
  purgedAt        DateTime?
  
  documents       Document[]
  
  // Dates
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  
  @@index([avocatId])
  @@index([statut])
  @@index([stripePaid])
  @@map("dossiers")
}

// ============================================
// DOCUMENT
// Purge automatique J+7
// ============================================
model Document {
  id              String          @id @default(cuid())
  dossierId       String
  dossier         Dossier         @relation(fields: [dossierId], references: [id], onDelete: Cascade)
  
  type            DocumentType?
  nomOriginal     String
  filename        String
  mimeType        String
  size            Int
  cheminStorage   String          // Path dans le storage
  fileData        String?         // Base64 pour envoi email
  
  // OBLIGATOIRE: OCR
  texteExtrait    String?         
  donneesExtraites String?        
  qualiteImage    String?
  
  // OBLIGATOIRE: Validation RAG
  exigeLegal      Boolean         @default(false)
  articleLoi      String?         // "Art. 229 Code Civil FR"
  estValide       Boolean         @default(false)
  
  // Sécurité
  hash            String
  
  // OBLIGATOIRE: Purge
  datePurge       DateTime?
  isPurged        Boolean         @default(false)
  purgedAt        DateTime?
  
  createdAt       DateTime  @default(now())
  
  @@index([dossierId])
  @@index([isPurged])
  @@map("documents")
}

// ============================================
// TexteLoi (Base RAG)
// ============================================
model TexteLoi {
  id              String          @id @default(cuid())
  
  // OBLIGATOIRE: Identification
  pays            Pays
  code            CodeLegal       // CODE_CIVIL, etc.
  article         String
  titre           String
  contenu         String          
  
  estActif        Boolean         @default(true)
  
  @@unique([pays, code, article])
  @@index([pays, code])
  @@map("textes_lois")
}

// ============================================
// ÉVÉNEMENTS (Audit)
// ============================================
model Event {
  id          String    @id @default(cuid())
  type        String    // case_created, payment_success, email_sent, email_opened, data_purged
  
  lawyerId    String?
  caseId      String?
  country     String?   // Pays concerné
  
  metadata    String?   // JSON 
  
  createdAt   DateTime  @default(now())
  
  @@index([type])
  @@index([country])
  @@index([createdAt])
  @@map("events")
}

enum Pays {
  FRANCE
  BELGIQUE
  SUISSE
  LUXEMBOURG
}

enum DossierStatus {
  BROUILLON
  EN_ATTENTE_PAIEMENT
  PAYE
  EN_ANALYSE
  ANALYSE_TERMINEE
  VALIDE
  PURGE
}

enum DocumentType {
  CARTE_IDENTITE
  ACTE_MARIAGE
  BULLETIN_SALAIRE
  AVIS_IMPOSITION
  RELEVE_BANCAIRE
  TITRE_PROPRIETE
  AUTRE
}

enum CodeLegal {
  CODE_CIVIL
  CODE_PROCEDURE_CIVILE
  CODE_FAMILLE
}
